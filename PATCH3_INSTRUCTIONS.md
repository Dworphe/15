# ПАТЧ №3 — Этап 2: Инструкции по применению

## Статус выполнения

✅ **ПАТЧ №3 полностью применен и готов к тестированию**

## Что было выполнено

### 1. Обновлены модели данных (`app/db/models.py`)
- Добавлены новые поля для Этапов A и B:
  - `pay_mins` - длительность Этапа A (дефолт: 20 минут)
  - `confirm_mins` - длительность Этапа B (дефолт: 10 минут)
  - `confirm_deadline_at` - дедлайн подтверждения трейдером

### 2. Расширен сервис баланса (`app/services/balance.py`)
- `reserve_usdt()` - резервирование USDT из баланса
- `release_usdt()` - возврат резерва в баланс
- `consume_reserved_usdt()` - окончательное списание из резерва

### 3. Обновлен планировщик (`app/scheduler.py`)
- `schedule_pay_timeout()` - таймер для Этапа A (оплата админом)
- `schedule_trader_confirm_window()` - окно для Этапа B (подтверждение трейдером)

### 4. Расширен воркер аукциона (`app/workers/auction.py`)
- `_after_winner_assigned()` - полная финализация после назначения победителя
- `pay_timeout()` - обработка таймаута оплаты админом
- `trader_confirm_timeout()` - обработка таймаута подтверждения трейдером

### 5. Создан хендлер победителя (`app/handlers/sell_winner.py`)
- `/pick_card <deal_id>` - выбор карты для получения перевода
- Сохранение снэпшотов карты (банк/маска/ФИО)
- Уведомление админов о выбранной карте
- Кнопка "Перевод выполнен" для админа
- Кнопка "Я ПОЛУЧИЛ ПЕРЕВОД" для трейдера
- Смена карты и отмена сделки

### 6. Обновлен бот (`app/bot.py`)
- Подключен `sell_winner_router` для работы с победителем

### 7. Созданы вспомогательные файлы
- `update_db_patch3.sql` - SQL-скрипт для обновления БД
- Обновлен `USAGE.md` с описанием ПАТЧА №3
- `PATCH3_INSTRUCTIONS.md` - этот файл

## Обновление базы данных

**ВАЖНО**: Перед запуском бота необходимо обновить базу данных!

### ПАТЧ №2 (если не выполнен)
```bash
sqlite3 data/app.db < update_db_patch2.sql
```

### ПАТЧ №3
```bash
sqlite3 data/app.db < update_db_patch3.sql
```

### Ручное выполнение команд ПАТЧА №3
```sql
-- Добавляем новые поля в таблицу deals для Этапов A и B
ALTER TABLE deals ADD COLUMN pay_mins INTEGER DEFAULT 20;
ALTER TABLE deals ADD COLUMN confirm_mins INTEGER DEFAULT 10;
ALTER TABLE deals ADD COLUMN confirm_deadline_at TIMESTAMP NULL;

-- Обновляем существующие записи
UPDATE deals SET pay_mins = 20 WHERE pay_mins IS NULL;
UPDATE deals SET confirm_mins = 10 WHERE confirm_mins IS NULL;
```

## Тестирование

### 1. Проверка импорта модулей
```bash
python -c "from app.db.models import *; print('Models OK')"
python -c "from app.scheduler import *; print('Scheduler OK')"
python -c "from app.workers.auction import *; print('Auction worker OK')"
python -c "from app.handlers.sell_winner import *; print('Winner handler OK')"
python -c "from app.bot import *; print('Bot OK')"
python -c "from app.main import *; print('Main OK')"
```

### 2. Запуск бота
```bash
python -m app.main
```

### 3. Тестирование функционала
1. **Админ**: `/admin` → "Торги → Продажа USDT (мастер)"
2. **Создание сделки**: пройти мастер создания
3. **Этап 1**: проверить рассылку трейдерам
4. **Принятие/отклонение**: проверить изменение REP
5. **Раунд ставок**: проверить автоматический запуск
6. **Ставки**: проверить прием и валидацию
7. **Определение победителя**: проверить статус WINNER_ASSIGNED
8. **Выбор карты**: `/pick_card <deal_id>` - выбрать карту
9. **Этап A**: админ подтверждает "Перевод выполнен"
10. **Этап B**: трейдер подтверждает "Я ПОЛУЧИЛ ПЕРЕВОД"
11. **Завершение**: проверить статус COMPLETED и балансы

## Acceptance Criteria (Этап 2)

✅ **Резервирование USDT**
- После назначения победителя USDT резервируется
- Статус меняется на WAITING_ADMIN_TRANSFER

✅ **Выбор карты**
- Победитель выбирает карту через `/pick_card <deal_id>`
- Сохраняются снэпшоты: банк, маска, держатель
- Админы уведомляются о выбранной карте

✅ **Этап A: Оплата админом**
- Админ нажимает "Перевод выполнен"
- Статус меняется на WAITING_TRADER_CONFIRM
- Запускается окно подтверждения (confirm_mins)

✅ **Этап B: Подтверждение трейдером**
- Трейдер нажимает "Я ПОЛУЧИЛ ПЕРЕВОД"
- Списывается резерв USDT
- Применяется вознаграждение к RUB-балансу
- Удерживается комиссия только с положительного вознаграждения
- Статус меняется на COMPLETED

✅ **Дополнительные функции**
- Смена карты возможна только до оплаты админом
- Отмена сделки → штраф 200 RUB + возврат резерва
- Таймауты A и B обрабатываются корректно

## Ограничения

❌ **НЕТ** автоматического списания USDT с карты трейдера
❌ **НЕТ** интеграции с банковскими API
❌ **НЕТ** автоматической проверки поступления средств

Эти функции требуют внешней интеграции.

## Структура файлов после ПАТЧА №3

```
app/
├── __init__.py
├── main.py              # ✅ Обновлен
├── bot.py               # ✅ Обновлен (добавлен sell_winner_router)
├── config.py            # ✅ Уже был готов
├── db/
│   ├── __init__.py
│   ├── base.py          # ✅ Уже был готов
│   └── models.py        # ✅ Полностью обновлен (ПАТЧИ №2+3)
├── handlers/
│   ├── __init__.py
│   ├── common.py        # ✅ Уже был готов
│   ├── auth.py          # ✅ Уже был готов
│   ├── admin.py         # ✅ Обновлен (BANK_LABELS)
│   ├── admin_settings.py # ✅ Уже был готов
│   ├── admin_deals.py   # ✅ Уже был готов
│   ├── admin_deals_sell.py # ✅ Уже был готов
│   ├── sell_auction.py  # ✅ Уже был готов
│   ├── sell_winner.py   # ✅ Новый (ПАТЧ №3)
│   ├── trader.py        # ✅ Уже был готов
│   └── utils.py         # ✅ Уже был готов
├── services/
│   ├── __init__.py
│   ├── settings.py      # ✅ Уже был готов
│   └── balance.py       # ✅ Полностью обновлен (ПАТЧИ №2+3)
├── utils/
│   ├── __init__.py
│   ├── validation.py    # ✅ Уже был готов
│   └── money.py         # ✅ Обновлен
├── workers/
│   ├── __init__.py      # ✅ Новый
│   └── auction.py       # ✅ Полностью обновлен (ПАТЧИ №2+3)
├── scheduler.py          # ✅ Полностью обновлен (ПАТЧИ №2+3)
└── logging_setup.py     # ✅ Уже был готов
```

## Следующие шаги

После успешного тестирования Этапа 2:

1. **Убедитесь**, что все модели созданы корректно
2. **Проверьте** работу планировщика и таймеров
3. **Протестируйте** полный цикл сделки от создания до завершения
4. **Готовьтесь** к интеграции с внешними системами

## Возможные проблемы

### 1. Ошибка импорта sell_winner
- Убедитесь, что файл `app/handlers/sell_winner.py` создан
- Проверьте корректность импортов в файле

### 2. Проблемы с резервированием USDT
- Проверьте, что поля `balance_usdt` и `reserved_usdt` добавлены в таблицу `users`
- Убедитесь, что функции баланса работают корректно

### 3. Ошибки планировщика
- Проверьте, что функции `schedule_pay_timeout` и `schedule_trader_confirm_window` работают
- Убедитесь, что файл `data/scheduler.db` создан

### 4. Проблемы с выбором карты
- Проверьте, что у пользователя есть карты в профиле
- Убедитесь, что связь между `User` и `TraderCard` работает корректно

## Контакты

При возникновении проблем:
1. Проверьте логи бота
2. Убедитесь, что все зависимости установлены
3. Проверьте корректность обновления БД
4. Убедитесь, что все файлы ПАТЧА №3 созданы

---

**ПАТЧ №3 успешно применен! 🎉**

Готов к тестированию полной финализации аукционов продажи USDT.
