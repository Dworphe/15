# üöÄ –ü–ê–¢–ß ‚Ññ19 ‚Äî –ü–æ–ª–Ω—ã–π —Ñ–∏–∫—Å –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–æ–π ¬´–ü–æ–∫—É–ø–∫–∏¬ª

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ü–æ–ª–Ω—ã–π —Ñ–∏–∫—Å –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ–∫—É–ø–∫–∏ —Å:
- ‚úÖ –ï–¥–∏–Ω—ã–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º (singleton)
- ‚úÖ UTC-aware –¥–∞—Ç–∞–º–∏
- ‚úÖ –û–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º-—Ç–∞–π–º–µ—Ä–æ–º –Ω–∞ chat+deal
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —ç—Ç–∞–ø–∞–º–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏
- ‚úÖ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ job-id

## üîß –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. –ï–¥–∏–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (singleton)
- **–§–∞–π–ª:** `app/scheduler.py`
- –ó–∞–º–µ–Ω–µ–Ω –Ω–∞ singleton —Å SQLAlchemyJobStore –¥–ª—è SQLite
- –í—Å–µ job-id —Ç–µ–ø–µ—Ä—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ

### 2. –í—Ä–µ–º—è ‚Äî —Ç–æ–ª—å–∫–æ UTC-aware
- **–§–∞–π–ª:** `app/utils/dt.py` (—É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω)
- –í—Å–µ –¥–∞—Ç—ã —Ç–µ–ø–µ—Ä—å —Å tzinfo –≤ UTC
- –§—É–Ω–∫—Ü–∏–∏ `now_tz()`, `to_aware_utc()`, `seconds_left()`, `fmt_mmss()`

### 3. UI —Ç–∞–π–º–µ—Ä—ã
- **–§–∞–π–ª:** `app/services/ui_timers.py` (–Ω–æ–≤—ã–π)
- –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ-—Ç–∞–π–º–µ—Ä –Ω–∞ chat+deal
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### 4. –ê–ø–¥–µ–π—Ç–µ—Ä —Ç–∞–π–º–µ—Ä–∞
- **–§–∞–π–ª:** `app/workers/timers.py` (–ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–µ–Ω)
- –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ job-id: `timer:buy:{deal_id}:{chat_id}`
- –ë–µ–∑ –¥—É–±–ª–µ–π, —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π —ç—Ç–∞–ø–æ–≤

### 5. –°–µ—Ä–≤–∏—Å –ø–æ—Ç–æ–∫–∞ –ø–æ–∫—É–ø–∫–∏
- **–§–∞–π–ª:** `app/services/buy_flow.py` (–Ω–æ–≤—ã–π)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–∞–º–∏: Stage1 ‚Üí Round1 ‚Üí RoundN ‚Üí Payment
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

### 6. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- **–§–∞–π–ª:** `app/db/models.py`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: `stage1_deadline_at`, `stage1_finished`, `is_paid`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ: `is_active` –≤ DealRound
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: `stage1_secs_default`, `pay_mins_default` –≤ SystemSettings

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∏
- **–§–∞–π–ª:** `app/services/settings.py`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ

### 8. –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª
- **–§–∞–π–ª:** `app/main.py`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `init_scheduler()` –≤–º–µ—Å—Ç–æ `get_scheduler(db_url)`

### 9. –ê–¥–º–∏–Ω-–º–∞—Å—Ç–µ—Ä
- **–§–∞–π–ª:** `app/handlers/admin_deals.py`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≠—Ç–∞–ø–∞ 1 –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤ —à–∞–≥–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–∞–ø–æ–≤

```
–≠—Ç–∞–ø 1 (Stage1): –ü—Ä–∏–Ω—è—Ç–∏–µ —É—á–∞—Å—Ç–∏—è
‚îú‚îÄ‚îÄ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: stage1_secs_default (60 —Å–µ–∫)
‚îú‚îÄ‚îÄ –°—Ç–∞—Ç—É—Å: OPEN
‚îú‚îÄ‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç/–æ—Ç–∫–ª–æ–Ω—è—é—Ç
‚îî‚îÄ‚îÄ –ü–µ—Ä–µ—Ö–æ–¥: ‚Üí Round1 –∏–ª–∏ CANCELLED

–†–∞—É–Ω–¥ 1 (Round1): –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
‚îú‚îÄ‚îÄ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: round_secs_default (20 —Å–µ–∫)
‚îú‚îÄ‚îÄ –°—Ç–∞—Ç—É—Å: BIDDING
‚îú‚îÄ‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
‚îî‚îÄ‚îÄ –ü–µ—Ä–µ—Ö–æ–¥: ‚Üí Payment –∏–ª–∏ Round2 (—Ç–∞–π-–±—Ä–µ–π–∫)

–†–∞—É–Ω–¥ N (RoundN): –¢–∞–π-–±—Ä–µ–π–∫
‚îú‚îÄ‚îÄ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: round_secs_default (20 —Å–µ–∫)
‚îú‚îÄ‚îÄ –ú–∞–∫—Å–∏–º—É–º: max_tie_rounds_default (5)
‚îú‚îÄ‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
‚îî‚îÄ‚îÄ –ü–µ—Ä–µ—Ö–æ–¥: ‚Üí Payment –∏–ª–∏ CANCELLED

–≠—Ç–∞–ø –æ–ø–ª–∞—Ç—ã (Payment): –û–ø–ª–∞—Ç–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–º
‚îú‚îÄ‚îÄ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: pay_mins_default (20 –º–∏–Ω)
‚îú‚îÄ‚îÄ –°—Ç–∞—Ç—É—Å: WAIT_PAYMENT
‚îú‚îÄ‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
‚îî‚îÄ‚îÄ –ü–µ—Ä–µ—Ö–æ–¥: ‚Üí DONE –∏–ª–∏ DISPUTE
```

## üîÑ Job-ID —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
–≠—Ç–∞–ø 1: deal:{deal_id}:stage1
–†–∞—É–Ω–¥ n: deal:{deal_id}:round:{n}
–û–ø–ª–∞—Ç–∞: deal:{deal_id}:pay
UI-—Ç–∞–π–º–µ—Ä: timer:buy:{deal_id}:{chat_id}
```

## üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL-—Å–∫—Ä–∏–ø—Ç
sqlite3 data/app.db < update_db_patch19.sql
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
```bash
python -c "from app.scheduler import get_scheduler, init_scheduler; print('‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫')"
python -c "from app.services.buy_flow import start_stage1_for_deal; print('‚úÖ buy_flow')"
python -c "from app.workers.timers import ensure_update_timer; print('‚úÖ –¢–∞–π–º–µ—Ä—ã')"
```

### 3. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
```bash
python -m app.main --check  # –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python -m app.main          # –∑–∞–ø—É—Å–∫
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
- –ö–æ–º–∞–Ω–¥–∞: `/deals`
- –ö–Ω–æ–ø–∫–∞: "‚ûï –ü–æ–∫—É–ø–∫–∞ (–º–∞—Å—Ç–µ—Ä)"
- –ü—Ä–æ–π—Ç–∏ –≤—Å–µ 11 —à–∞–≥–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —Å–æ–∑–¥–∞–ª–∞—Å—å –∑–∞–ø–∏—Å—å –≤ –ë–î

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≠—Ç–∞–ø–∞ 1
- –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è: `Added timer job timer:buy:{id}:{chat_id}`
- –î–æ–ª–∂–Ω–∞ –¥–æ–±–∞–≤–∏—Ç—å—Å—è job: `deal:{id}:stage1`
- –¢–∞–π–º–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: "‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: MM:SS"

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –†–∞—É–Ω–¥—É 1
- –ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≠—Ç–∞–ø–∞ 1 –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å—Å—è –∑–∞–ø–∏—Å—å –≤ `deal_rounds`
- –î–æ–ª–∂–Ω–∞ –¥–æ–±–∞–≤–∏—Ç—å—Å—è job: `deal:{id}:round:1`
- –°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –Ω–∞ `BIDDING`

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–µ—Ä–∞
- –¢–∞–π–º–µ—Ä –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞
- –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## üö® –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. –ë–µ–∑ Redis
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ SQLite
- APScheduler —Å SQLAlchemyJobStore

### 2. UTC –≤—Ä–µ–º—è
- –í—Å–µ –¥–∞—Ç—ã –≤ UTC —Å tzinfo
- –ù–∏–∫–∞–∫–∏—Ö `datetime.utcnow()` –∏–ª–∏ `datetime.now()`

### 3. –û–¥–∏–Ω —Ç–∞–π–º–µ—Ä
- –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ-—Ç–∞–π–º–µ—Ä –Ω–∞ chat+deal
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### 4. –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ID
- –í—Å–µ job-id —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–æ —à–∞–±–ª–æ–Ω—É
- –ù–∏–∫–∞–∫–∏—Ö —Å–ª—É—á–∞–π–Ω—ã—Ö UUID

## üîç –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
```python
# –í –∫–æ–¥–µ
log.info("Added timer job %s", job_id)
log.info("Deal %s cancelled: no participants", deal_id)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ job –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ
```python
scheduler = get_scheduler()
jobs = scheduler.get_jobs()
for job in jobs:
    print(f"{job.id}: {job.func_name} -> {job.next_run_time}")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è
SELECT id, deal_no, stage1_deadline_at, stage1_finished, is_paid FROM deals LIMIT 5;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—É–Ω–¥—ã
SELECT * FROM deal_rounds WHERE is_active = 1;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–π–º–µ—Ä—ã
SELECT * FROM ui_timer_messages;
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ç—á–∞:
1. **–ú–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–∞—è –ø–æ–∫—É–ø–∫–∞** —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **–¢–∞–π–º–µ—Ä—ã** –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
3. **–ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ
4. **Job-id** –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –±–µ–∑ –¥—É–±–ª–µ–π
5. **–í—Ä–µ–º—è** –≤–µ–∑–¥–µ –≤ UTC
6. **–û–¥–∏–Ω —Ç–∞–π–º–µ—Ä** –Ω–∞ chat+deal

## üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å job –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ: `scheduler.get_jobs()`
